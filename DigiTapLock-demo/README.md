This project creates a simple connected relay using a TapNLink module and an app for access code entry. The project uses TapNLink's embedded Java Virtual Machine (JVM) as the application processor. The JVM runs a simple Java program and controls the access to a connected device such as a door lock.

>> Note: Before starting, learn how TapNLink and the associated tools work in this [Getting Started](http://docs.iotize.com/GettingStarted/).

This project is [on GitHub](https://github.com/iotize-sas/DigiTapLock-demo) !

The project has 4 folders:

- `app_generated/DigiTapLock.apk`: The sources for the mobile application that was automatically generated by the IoTize mobile app build server.
- `java/DigiTapLock.java`: The Java code that is executed by the `JVM`.
- `iotize_studio/DigiTapLock.iotz`: The IoTize Studio configuration file that is used to configure the TapNLink for this demo.
- `doc`: The illustrations and the readme file for the java code.

## The Main Components

The main component used in this project is the TapNLink communication module. You can purchase [it here.](https://www.digikey.fr/product-detail/fr/iotize/TNL-FIT203/2087-TNL-FIT203-ND/12397002).

## How it Works

These pictures show the hardware. An extension cord has been cut, and each half has been connected to the relay board.
<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/DigiTapLock-demo/doc/images/picture_1.jpg" width="250">
</p>
<p align="center">
    <em>The assembled cord and relay</em>
</p>
<p>
The relay acts as a spy between the mains plug and the load.
</p>

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/DigiTapLock-demo/doc/images/picture_2.jpg" width="250">
</p>
<p align="center">
    <em>Inside the relay casing</em>
</p>
<p>
Inside the plastic casing, the TapNLink module is linked with a ribbon cable to the relay.
</p>

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/DigiTapLock-demo/doc/images/picture_3.jpg" width="250">
</p>
<p align="center">
    <em>The relay</em>
</p>
<p>
The relay element switches the current to the device on and off. 
</p>

The red cable will be replaced by a button, to ask if access is possible.

## Overview

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/DigiTapLock-demo/doc/images/overview.jpg">
</p>
<p align="center">
    <em>General view of the project</em>
</p>

## Schematic

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/DigiTapLock-demo/doc/images/schematic.png">
</p>
<p align="center">
    <em>Electrical diagram</em>
</p>

## Java code

The `Java` code embedded in the `JVM` allows us to do an `onCheck()` call each time interval (This is defined in the `TapNLinkVar` construct). With this `onCheck()` method, by verifying that the provided `id` corresponds to the desired `id`, we will be able to perform data recovery tasks. The `TapNLinkVar` value also updates or sends an MQTT message.

- For more `java` code information, [click here](https://github.com/iotize-sas/DigiTapLock-demo/doc/Java_code/Java_code.md)!

## IoTize Studio

1. Open the TapNLink configruation project `iotize_studio/DigiTapLock.iotz` with IoTize Studio. For more information about Studio, [click here](http://docs.iotize.com/UserManuals/IotizeStudio/).
2. In the `IoTize_Studio/Tap` section, set `User internal JVM` to `Yes` and set the `.java` file path `java/DigiTapLock.java`.
3. In IoTize Studio execute the `java` build to generate the `.bcb` file. 
4. Configure your `TapNLink` using `IoTize Studio` :
    -  [Setup the connection to your TapNLink](http://docs.iotize.com/UserManuals/DiverseTools/)
    -  Click on the `Configure` button, and wait for the end of the configuration process.
5. Reboot the TapNLink to apply the new configuration. 

## Launching the 'DigiTapLock' App

- Because this app has not been published on app stores, you have to install it manually. See how this is done [here](https://github.com/iotize-sas/DigiTapLock-demo/app_generated/DigiTapLock.apk).
- After your circuit is properly connected, and your TapNLink is configured, launch the mobile app. The fastest way is to approach your mobile phone (with NFC enabled) to the plastic casing. NFC will launch the app and connect the mobile to the TapNLink automatically.  

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/DigiTapLock-demo/doc/images/picture_end.jpg" width="400">
</p>
<p align="center">
   <em>DigiTapLock connected to a device</em>
</p>

- With `TapNLink`, you can now monitor and control access to your device.

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/DigiTapLock-demo/doc/images/app_1.jpg" width="200">
</p>
<p align="center">
    <em>View of the app</em>
</p>

## Access Control

First, login using the admin account to access the control dashboard.


<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/DigiTapLock-demo/doc/images/app_2.jpg" width="200">
</p>
<p align="center">
    <em>Access panel</em>
</p>
In the Access panel, you can change the number of times remaining for access. You can set up to 21 different access codes for your device.


<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/DigiTapLock-demo/doc/images/app_3.jpg" width="200">
</p>
<p align="center">
    <em>Control panel</em>
</p>
In this panel, you can constrain the access to certain hours. For example, if access is enabled for 11 AM, when you press the button you will be able to access the device.

## DigiTapLock v2

>> To install this version, you must unistall the wattTap app on your mobile and then install this one. This version provides:  


<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/DigiTapLock-demo/doc/images/v2_1.jpg" width="250">
</p>
<p align="center">
    <em>New code input interface</em>
</p>
A digital keypad for code entry.


<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/DigiTapLock-demo/doc/images/v2_2.jpg" width="250">
</p>
<p align="center">
    <em>Connection preferences</em>
</p>
The preferences can enable the storage of the last code that was entered using the keypad. When the mobile connects to the TapNLink (NFC, BLE, or WiFi), that last code is sent automatically. You do not have to type it again. 

