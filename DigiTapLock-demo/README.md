# DigiTapLock

This article presents a simple connected relay based on a TapNLink module. The only 'processor' is the Java Virtual Machine embedded into the TapNLink module that runs a simple Java program. 
This one control the access of the device connected.

>> Note: if you wish to understand how works TapNLink and the associated tools (IoTize Studio), see [Getting Started](http://docs.iotize.com/GettingStarted/).

To find the project on GitHub, [it's here](https://github.com/iotize-sas/DigiTapLock-demo) !

It's composed of 4 folders:

- `app_generated/DigiTapLock.apk`: Source for the mobile application. It was auto generated by IoTize mobile app build server.
- `java/DigiTapLock.java`: Contains a Java code which will be executed by the `JVM`.
- `iotize_studio/DigiTapLock.iotz`: IoTize Studio configuration file to configure the TapNLink for the demo.
- `doc`: Contains a pictures and java code readme file.

## The main components

If you wish to purchase the main components follow these links:
- TapNLink (the communication module), [it's here](https://www.digikey.fr/product-detail/fr/iotize/TNL-FIT203/2087-TNL-FIT203-ND/12397002).

## How it works

Below a few pictures. An extension cord has been cut and each half has been connected to the board.
<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/tree/main/DigiTapLock-demo/doc/images/picture_1.jpg" width="250">
</p>
<p align="center">
    <em>Assembly of the relay</em>
</p>
<p>
The relay acts as a spy between the mains plug and the load.
</p>

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/tree/main/DigiTapLock-demo/doc/images/picture_2.jpg" width="250">
</p>
<p align="center">
    <em>Inside of the case</em>
</p>
<p>
In the plastic case, the TapNLink module is linked with a small ribbon cable.
</p>

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/tree/main/DigiTapLock-demo/doc/images/picture_3.jpg" width="250">
</p>
<p align="center">
    <em>Tap relay</em>
</p>
<p>
The relay element switch ON/OFF the device current. 
</p>

The red cable will be replaced by a button, to ask if access has possible.

## Overview

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/tree/main/DigiTapLock-demo/doc/images/overview.jpg">
</p>
<p align="center">
    <em>General view of the project</em>
</p>

## Schematic

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/tree/main/DigiTapLock-demo/doc/images/schematic.png">
</p>
<p align="center">
    <em>Electric diagram</em>
</p>

## Java code

The `Java` code embedded in the `JVM` will allow us to make a `onCheck()` method call every time (This time is defined in a `TapNLinkVar` constructor). In this onCheck() method, by verifying that the passed `id` corresponds to the desired one, we will be able to perform data recovery tasks, also `TapNLinkVar` value updates or send MQTT message.

- To find more `Java` code information, [it's here](https://github.com/iotize-sas/DigiTapLock-demo/doc/Java_code/Java_code.md) !

## IoTize Studio

1. Open `iotize_studio/DigiTapLock.iotz` with IoTize Studio. For more information about Studio, see [it's here](http://docs.iotize.com/UserManuals/IotizeStudio/).
2. On `IoTize_Studio/Tap`, define `User internal JVM` on `Yes` and select the `.java` file path `java/DigiTapLock.java`.
3. On Studio execute `java` build for generate `.bcb` file. 
4. Configure your `TapNLink` with `IoTize Studio` :
    -  [Setup connection to your Tap](http://docs.iotize.com/UserManuals/DiverseTools/)
    -  Click on `Configure` button and wait for the end of the configuration process. 
5. Reboot the tap to apply the new configuration. 

## Running the 'DigiTapLock' app

- Because the App has not been published onto the stores, you have to install it manually, see [it's here](https://github.com/iotize-sas/DigiTapLock-demo/app_generated/DigiTapLock.apk).
- Once your circuit is properly connect, and your TapNLink configured, you can launch the mobile app. The fastest way consists in approach your mobile phone (with NFC enabled) to the plastic enclosure. The NFC will launch the app and connect automatically to the TapNLink. 

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/tree/main/DigiTapLock-demo/doc/images/picture_end.jpg" width="400">
</p>
<p align="center">
   <em>DigiTapLock connected to a device</em>
</p>

- Thanks to the `TapNLink`you can now monitor the access of your device.

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/tree/main/DigiTapLock-demo/doc/images/app_1.jpg" width="200">
</p>
<p align="center">
    <em>Viewing the application</em>
</p>

## Control of access

Login with admin account to access of the control dashboard.


<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/tree/main/DigiTapLock-demo/doc/images/app_2.jpg" width="200">
</p>
<p align="center">
    <em>Access Bundle</em>
</p>
On Access bundle you can change the time remaining on access. You can edit 21 codes to access has your device.


<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/tree/main/DigiTapLock-demo/doc/images/app_3.jpg" width="200">
</p>
<p align="center">
    <em>Control Bundle</em>
</p>
On this dashboard you can define the status of the door when the button has pressed. If at 11AM the data has enable, then when you press the button you can access to the device

## DigiTapLock v2

>> Note: if you want to install this version, you must unistall the other wattTap version on your mobile than install this one.

After a few hours of changes to the generated code, I was able to make the following changes:  


<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/tree/main/DigiTapLock-demo/doc/images/v2_1.jpg" width="250">
</p>
<p align="center">
    <em>New input code</em>
</p>
The code can be input with digital keyboard now.


<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/tree/main/DigiTapLock-demo/doc/images/v2_2.jpg" width="250">
</p>
<p align="center">
    <em>Preferences connection</em>
</p>
The preferences contain the last code input. Then when you connect to NFC/BLE/WiFi the code has input automatically 

