# TapCO2

<div class="hide-in-wordpress-post">

<video src="https://user-images.githubusercontent.com/38251071/123762612-43a45e80-d8c3-11eb-8e61-0bc675535db3.mp4" style="width: 250px;margin: auto;display: flex;max-width: 100%;" controls="">https://user-images.githubusercontent.com/38251071/123762612-43a45e80-d8c3-11eb-8e61-0bc675535db3.mp4</video>

</div>

This project creates a connected CO2 sensor using a TapNLink module. The project uses TapNLink's embedded Java Virtual Machine (JVM) as the application processor. The JVM runs a simple Java program retrieves data from sensor.

## *** DISCLAIMER ***

<p>This electrical project is provided ONLY for testing and experimentation by qualified persons in electronics design labs.</p>

<p>The person reproducing this example accepts full responsibility to any injury, or damage that may result.</p>

<p>This example is not a product. This example is not Certified, Qualified, Approved, or Recommended for any commercial use, or for any use by the general public.</p>

>> Note: Before starting, learn how TapNLink and the associated tools work in this [Getting Started](http://docs.iotize.com/GettingStarted/).

This project is on [GitHub](https://github.com/iotize-sas/Open-Projects/tree/main/TapCO2-demo) !

The project has 4 folders:

- `app_generated/TapCO2.apk`: The sources for the mobile application that was automatically generated by the IoTize mobile app build server.
- `java/TapCO2.java`: The Java code that is executed by the `JVM`.
- `iotize_studio/TapCO2.iotz`: The IoTize Studio configuration file that is used to configure the TapNLink for this demo.
- `doc`: The illustrations and the readme file for the `Java` code.


## The Main Components

The main components in this project, and where you can purchase them are:
- The TapNLink communication module [is available from these distributors](https://www.iotize.com/iotize-distributors.html).
- A CO2 sensor (STC31-R3) from Sensirion connected to the Tap by IÂ²C. 

## How it Works

The components are placed in a plastic case (vertical cylinder) with a few holes for aeration. The pictures below show the hardware set up :

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/TapCO2-demo/doc/images/1.jpg" width="250">
</p>
<p align="center">
    <em>TapCO2 components</em>
</p>

- Tap and CO2 Sensor are separated so that the heat released by Tap does not affect the recovered values (but the heat from the regulator impacts the measurement).

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/TapCO2-demo/doc/images/2.jpg" width="250">
</p>
<p align="center">
    <em>The CO2 sensor</em>
</p>

- The co2 sensor is powered by the 5V power pack USB battery.

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/TapCO2-demo/doc/images/3.jpg" width="250">
</p>
<p align="center">
    <em>TapNLink</em>
</p>

- The Tap is connected to the CO2 sensor by I2C and is powered by the sensor board. Note that the regulator is (unfortunately) on the same board that the sensor. This is NOT a good idea because the quality of the measurement depends on the temperature. But it makes things easier since we use a 5V USB rechargeable battery (power pack). 

## Overview

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/TapCO2-demo/doc/images/overview.jpg">
</p>
<p align="center">
    <em>General view of the project</em>
</p>
<p>
The general diagram shows the battery connected to the sensor. The TapNLink module reads the information from the sensor with I2C communication. This data is viewed in an app that is generated automatically by the IoTize software tools based on the configuration of the TapNLink.
</p>

## Schematic 

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/TapCO2-demo/doc/images/schematic.png">
</p>
<p align="center">
    <em>Electrical diagram</em>
</p>

## Java Code

In the `Java` code executed by the `JVM`, the `onCheck()` method is called periodically (the period is specified in the `TapNLinkVar` construct). With this method, we get an image of the power by considering the differences of the pulse counts during the elapsed time period. 

- For more `Java` code information, [click here](https://github.com/iotize-sas/Open-Projects/tree/main/TapCO2-demo/doc/Java_code/Java_code.md) !


## IoTize Studio

1. Open the TapNLink configuration project `iotize_studio/TapCO2.iotz` with IoTize Studio. For more information about Studio, [click here](http://docs.iotize.com/UserManuals/IotizeStudio/).
2. In the `IoTize_Studio/Tap` section, set `User internal JVM` to `Yes` and set the `.java` file path `java/TapCO2.java`.
3. In IoTize Studio, execute `java` build to generate the `.bcb` file. 
4. Configure your `TapNLink` with `IoTize Studio` :
    -  [Setup the connection to your TapNLink](http://docs.iotize.com/UserManuals/DiverseTools/)
    -  [Set the IoT Platform (MQTT) information](http://docs.iotize.com/Technologies/AWSIot/).
    -  Click on the `Configure` button and wait for the end of the configuration process. 
5. Reboot the TapNLink to apply the new configuration. 


## Running the 'TapCO2' App

- Because this app has not been published on the app stores, you have to install it manually. See how this is done [here](https://github.com/iotize-sas/Open-Projects/tree/main/TapCO2-demo/app_generated/TapCO2.apk).
- After your circuit is properly connected, and your TapNLink configured, launch the mobile app. The fastest way is to approach your mobile phone (with NFC enabled) to the plastic casing. NFC will launch the app and connect the mobile to the TapNLink automatically. 

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/TapCO2-demo/doc/images/4.jpg" width="400">
</p>
<p align="center">
   <em>TapCO2 connected</em>
</p>

- With `TapNLink`, you can now monitor the instantaneous value, or the percentage data that has been stored in the module. 

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/TapCO2-demo/doc/images/app.jpg" width="200">
</p>
<p align="center">
    <em>Viewing in the app</em>
</p>

## Known issues
-  we have designed the plastic case for a specific battery: Duracell Powerbank 3350 mAh. This battery features an automatic power off when the consumption is too low, and the problem was to increase the consumption in order to avoir the automatic power off... The solution we found consists in configuring the TapNLink in Access Point (the consumption is higher for AP than for Station mode) and to discard any 'low power' option. Unfortunately, the device is not able to sendMQTT messages (alarm to the Cloud) when it is in Access Point mode... For sure, it would be better to replace the battery by another that does not switch off the power!
-  because of the 3.3V regulator, the temperature of the sensor board is too high. It impacts on the quality measurement (even more because of the previous issue). 
-  in the same way, it would be much better to get the current atmospheric pressure from the Cloud. But the first issue cancel any direct internet connection... 

In conclusion, the measurement are neither very accurate nor very stable. Replacing the battery would be a first good step (it would allow to reduce the overall consumption, the temperature of the sensor board and finally it would provide an access to the internet). 
