This project implements TapNLink in a relay, so that the state of the relay can be changed from a mobile app. The project uses TapNLink's embedded Java Virtual Machine (JVM) as the application processor. The JVM runs a simple Java program to control the relay. 

>> Note: Before starting, learn how TapNLink and the associated tools work in this [Getting Started](http://docs.iotize.com/GettingStarted/).

This project is on, [Github](https://github.com/iotize-sas/Open-Projects/tree/main/TimerSwitch-demo) !

The project has 4 folders:

- `app_generated/TimerSwitch.apk`: The sources for the mobile application that was automatically generated by the IoTize mobile app build server.
- `java/TimerSwitch.java`: The Java code that is executed by the `JVM`.
- `iotize_studio/WattTap.iotz`: The IoTize Studio configuration file that is used to configure the TapNLink for this demo.
- `doc`: The illustrations and the readme file for the java code.

## The Main Components

The main components of this project, and where you can purchase them are:
- TapNLink communication module [is available from these distibutors](https://www.iotize.com/iotize-distributors.html).

- Plastic casing [is available here](https://www.aliexpress.com/item/4000287507400.html?spm=a2g0o.productlist.0.0.309d44dfcbyy66&algo_pvid=642dec70-5635-4468-b159-30d6b13c2028&algo_expid=642dec70-5635-4468-b159-30d6b13c2028-3&btsid=2100bb5116136655014285201e8088&ws_ab_test=searchweb0_0,searchweb201602_,searchweb201603_).

## How it Works

These pictures show the hardware. An extension cord has been cut and each half has been connected to the relay board.
<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/TimerSwitch-demo/doc/images/picture_1.jpg" width="250">
</p>
<p align="center">
    <em>Assembly of the relay</em>
</p>
<p>
The relay acts as a switch between the mains plug and the load.
</p>

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/TimerSwitch-demo/doc/images/picture_2.jpg" width="250">
</p>
<p align="center">
    <em>Inside of the relay casing</em>
</p>
<p>
Inside the plastic casing, the TapNLink module is linked to the relay with a ribbon cable.
</p>

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/TimerSwitch-demo/doc/images/picture_3.jpg" width="250">
</p>
<p align="center">
    <em>Tap relay</em>
</p>
<p>
The relay element switches the current to the device on and off. 
</p>

## Overview

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/TimerSwitch-demo/doc/images/overview.png">
</p>
<p align="center">
    <em>General view of the project</em>
</p>

## Schematic

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/TimerSwitch-demo/doc/images/schematic.png">
</p>
<p align="center">
    <em>Electrical diagram</em>
</p>

## Java code

The `Java` code embedded in the `JVM` allows us to do an `onCheck()` call at each time interval (This interval is defined in a `TapNLinkVar` construct). With this `onCheck()` method, by verifying that the provided `id` corresponds to the desired `id`, we will be able to perform data recovery tasks. The `TapNLinkVar` value updates or sends an MQTT message.

- For more `java` code information, [click here](https://github.com/iotize-sas/Open-Projects/tree/main/TimerSwitch-demo/doc/Java_code/Java_code.md) !

## IoTize Studio

1. Open the TapNLink configuration project `iotize_studio/TimerSwitch.iotz` with IoTize Studio. For more information about IoTize Studio, [click here](http://docs.iotize.com/UserManuals/IotizeStudio/).
2. In the `IoTize_Studio/Tap` section, set `User internal JVM` to `Yes`, and set the `.java` file path `java/TimerSwitch.java`.
3. In IoTize Studio execute `java` build to generate the `.bcb` file.
4. Configure your `TapNLink` with `IoTize Studio` :
    -  [Setup the connection to your TapNLink](http://docs.iotize.com/UserManuals/DiverseTools/)
    -  Click on the `Configure` button and wait for the end of the configuration process. 
5. Reboot the TapNLink to apply the new configuration. 

## Running the 'TimerSwitch' App

- Because this app has not been published on app stores, you have to install it manually. See how this is done [here](https://github.com/iotize-sas/Open-Projects/tree/main/TimerSwitch-demo/app_generated/TimerSwitch.apk).
- After your circuit is properly connected, and your TapNLink configured, launch the mobile app. The fastest way is to approach your mobile phone (with NFC enabled) to the plastic casing. NFC will launch the app and connect the mobile to the TapNLink automatically.
- With `TapNLink`, you can now monitor and control the relay status. 


## Active Mode

Defining the mode in the State panel allows you to either force the state of the relay (On/Off), or to set it to Auto so that the system manages the state according to a daily set up.

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/TimerSwitch-demo/doc/images/view_1.jpg" width="200">
</p>
<p align="center">
    <em>State panel</em>
</p>

## Manual On

Pressing the button to manually change the state to On has priority. Pressing the button switches the state to On for the amount of time that is defined in the Access panel.

 <p align="center">
 <img src="https://github.com/iotize-sas/Open-Projects/blob/main/TimerSwitch-demo/doc/images/view_3.jpg" width="200">
 </p>
 <p align="center">
     <em>Manual On duration and progress</em>
 </p>
 
 ## Automatic Run
 
This option makes it possible to automatically return to Auto mode at the change of the hour. When Automatic Run is active, the mode is retrieved from the daily setup at the change of the hour.

 <p align="center">
 <img src="https://github.com/iotize-sas/Open-Projects/blob/main/TimerSwitch-demo/doc/images/view_2.jpg" width="200">
 </p>
 <p align="center">
     <em>Return to Auto mode</em>
 </p>
