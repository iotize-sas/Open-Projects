# WattTap


https://user-images.githubusercontent.com/38251071/123656314-18246400-d830-11eb-9628-80c02c4a8b3a.mp4



This project creates a connected Wattmeter using a TapNLink module. The project uses TapNLink's embedded Java Virtual Machine (JVM) as the application processor. The JVM runs a simple Java program retrieves power consumption data from the Wattmeter.

## *** WARNING ***

<p>THE WATTMETER IN THIS DESIGN CONNECTS DIRECTLY TO 220 VOLT MAINS POWER.</p> 

<p>Physical contact with any component of the design can cause electrocution resulting in serious INJURY, or DEATH.</p> 

<p>DO NOT reproduce this design without appropriate knowledge of, and protective measures for working with mains power.</p>

<p>Disconnect power before handling the material or manipulating the connections. Ensure that material is properly grounded and isolated. Always work with another adult present in case of an emergency.</p>

## *** DISCLAIMER ***

<p>This electrical project is provided ONLY for testing and experimentation by qualified persons in electronics design labs.</p>

<p>The person reproducing this example accepts full responsibility to any injury, or damage that may result.</p>

<p>This example is not a product. This example is not Certified, Qualified, Approved, or Recommended for any commercial use, or for any use by the general public.</p>

>> Note: Before starting, learn how TapNLink and the associated tools work in this [Getting Started](http://docs.iotize.com/GettingStarted/).

This project is on [GitHub](https://github.com/iotize-sas/Open-Projects/tree/main/WattTap-demo) !

The project has 4 folders:

- `app_generated/WattTap.apk`: The sources for the mobile application that was automatically generated by the IoTize mobile app build server.
- `java/WattTap.java`: The Java code that is executed by the `JVM`.
- `iotize_studio/WattTap.iotz`: The IoTize Studio configuration file that is used to configure the TapNLink for this demo.
- `doc/WattTapDemo.pdf`: The illustrations and the readme file for the `Java` code.


## The Main Components

The main components in this project, and where you can purchase them are:
- The TapNLink communication module [is available from these distributors](https://www.iotize.com/iotize-distributors.html).
- The BL0937 power sensor [is available here](https://www.aliexpress.com/wholesale?catId=0&initiative_id=SB_20210218083908&isPremium=y&SearchText=bl0937).
- The plastic casing [is available here](https://www.aliexpress.com/item/4000287507400.html?spm=a2g0o.productlist.0.0.309d44dfcbyy66&algo_pvid=642dec70-5635-4468-b159-30d6b13c2028&algo_expid=642dec70-5635-4468-b159-30d6b13c2028-3&btsid=2100bb5116136655014285201e8088&ws_ab_test=searchweb0_0,searchweb201602_,searchweb201603_).


## How it Works

The pictures below show the hardware set up. An extension cord has been cut and each half has been connected to the board:

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/WattTap-demo/doc/images/picture_1.jpg" width="250">
</p>
<p align="center">
    <em>Wattmeter, cord assembly</em>
</p>
<p>
The wattmeter acts as a spy between the mains plug and the load.
</p>
<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/WattTap-demo/doc/images/picture_2.jpg" width="250">
</p>
<p align="center">
    <em>Inside the plastic casing</em>
</p>
<p>
Inside the plastic case, the TapNLink module is linked to the board using a ribbon cable.
</p>

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/WattTap-demo/doc/images/picture_3.jpg" width="250">
</p>
<p align="center">
    <em>TapNLink isolation</em>
</p>
<p>
Kapton tape is added for isolation between the TapNLink and the main board to avoid a short.
</p>

## Overview

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/WattTap-demo/doc/images/diagram.png">
</p>
<p align="center">
    <em>General view of the project</em>
</p>
<p>
The general diagram shows the mains plug connected to the wattmeter. The wattmeter is based on a single component (BL0937) that measures both the current and the voltage and calculates the instantaneous power consumption. The TapNLink module reads the information from the wattmeter and transmits the data to a smartphone. This data is viewed in an app that is generated automatically by the IoTize software tools based on the configuration of the TapNLink.
</p>

## Schematic 

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/WattTap-demo/doc/images/wattmeter.png">
</p>
<p align="center">
    <em>Electrical diagram</em>
</p>
<p>
The current is measured through R1 (1 mOhm resistor). The voltage is divided through a series of 330ko resistors before reaching the sensor. Using several resistors is preferred because of the high voltage. 
</p>

#### BL0937 to TapNLink
The TapNLink has two extension connectors. The 'target connector' is used as a set of simple GPIOs. Because the data is sent as a series of pulses, the input will be configured as counters. The power is proportional to the frequency of the output signals. 
The BL0937 has two outputs: 
- `CF0` (power) is connected to TARGET_RST of the TapNLink
- `CF1` (current/voltage) is connected to the `TARGET_SWDIO`pin
The selection of current or voltage is done with `SEL`  connected to the `TARGET_SWDIO`pin.

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/WattTap-demo/doc/images/tap_targ.png" width="300">
</p>
<p align="center">
    <em>TapNLink target connector</em>
</p>

## Java Code

In the `Java` code executed by the `JVM`, the `onCheck()` method is called periodically (the period is specified in the `TapNLinkVar` construct). With this method, we get an image of the power by considering the differences of the pulse counts during the elapsed time period. 

- For more `Java` code information, [click here](https://github.com/iotize-sas/Open-Projects/tree/main/WattTap-demo/doc/Java_code/Java_code.md) !


## IoTize Studio

1. Open the TapNLink configuration project `iotize_studio/WattTap.iotz` with IoTize Studio. For more information about Studio, [click here](http://docs.iotize.com/UserManuals/IotizeStudio/).
2. In the `IoTize_Studio/Tap` section, set `User internal JVM` to `Yes` and set the `.java` file path `java/WattTap.java`.
3. In IoTize Studio, execute `java` build to generate the `.bcb` file. 
4. Configure your `TapNLink` with `IoTize Studio` :
    -  [Setup the connection to your TapNLink](http://docs.iotize.com/UserManuals/DiverseTools/)
    -  [Set the IoT Platform (MQTT) information](http://docs.iotize.com/Technologies/AWSIot/).
    -  Click on the `Configure` button and wait for the end of the configuration process. 
5. Reboot the TapNLink to apply the new configuration. 


## Running the 'WattTap' App

- Because this app has not been published on the app stores, you have to install it manually. See how this is done [here](https://github.com/iotize-sas/Open-Projects/tree/main/WattTap-demo/app_generated/WattTap.apk).
- After your circuit is properly connected, and your TapNLink configured, launch the mobile app. The fastest way is to approach your mobile phone (with NFC enabled) to the plastic casing. NFC will launch the app and connect the mobile to the TapNLink automatically. 

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/WattTap-demo/doc/images/picture_end.jpg" width="400">
</p>
<p align="center">
   <em>Wattmeter connected to an electric radiator</em>
</p>

- With `TapNLink`, you can now monitor the instantaneous power consumption, or the consumption data that has been stored in the module. 

<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/WattTap-demo/doc/images/app.jpg" width="200">
</p>
<p align="center">
    <em>Viewing in the app</em>
</p>

## Calibration

Because the components used are not very precise, you should calibrate our Wattmeter using a multimeter. Our focus is on measuring active power and requires a a pure resistor. We use an electric radiator. Do not use an appliance like your washing machine that may have high inductance. 

1. `Login` to the WattTap application using the admin account to access more parameters.
2. After connecting, the `Calibration` view is displayed. Click on this.
3. Now, set the active power, current and voltage factors to 1.
<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/WattTap-demo/doc/images/app_calibration.jpg" width="200">
</p>
<p align="center">
    <em>Calibration value</em>
</p>
4. Now the pulse from active power, current and voltage are not adjusted by a calibration factor.


>>
> Here are examples for calculating the calibration factor for each of the values:

#### Voltage :

- Read the voltmeter value (ex. 230V)
- Read the WattTap value (ex. 1765) 
- Divide the voltmeter value by the WattTap value: (ex. 230 / 1765 = 0.1303116147308782)
- Set the voltage calibration value in WattTap to the calculated value. (ex. 0.13031)

#### Electric Current

- Read the voltmeter value (ex. 4 A)
- Read the WattTap value (ex. 561)
- Divide the voltmeter value by the WattTap value:
(ex. 4 / 561 = 0.0071301247771836)
- Set the Electric Current calibration value in WattTap to the calculated value. (ex. 0.00713)

#### Active Power:

- Take the Voltage and Current values from the voltmeter. (ex. 230V and 4A)
- Read the Active Power value in WattTap. (ex. 985)
- Multiply the voltmeter values for Voltage and Current. (ex. 230 * 4 = 920)
- Divide this calculated value by the Active Power value from WattTap.
(ex. 920 / 985 = 0.934010152284264)
- Set the Active Power calibration value in WattTap to the calculated value. (ex. 0.93401)

## Send Data Message to AWS

<p>
Login with the TapNLink admin account and set update shadow on AWS to `active`.
</p>
<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/WattTap-demo/doc/images/picture_aws.jpg" width="200">
</p>
<p align="center">
    <em>Turn on MQTT messaging to AWS</em>
</p>

>> You must set the correct `AWS` information in the TapNLink `IoT Platform (MQTT)`. If not, the `JVM` will be stopped after a few seconds when TapNLink tries to send the messages.


When everything is correctly set up, data messages are received for the AWS Thing for your TapNLink.
<p align="center">
<img src="https://github.com/iotize-sas/Open-Projects/blob/main/WattTap-demo/doc/images/mqtt_shadow.png" width="800">
</p>
<p align="center">
    <em>AWS MQTT message</em>
</p>

## More Information

- For more information about the creation of this project, [click here](https://github.com/iotize-sas/Open-Projects/tree/main/WattTap-demo/doc/WattTapDemo.pdf).
