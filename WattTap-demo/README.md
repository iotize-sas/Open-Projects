# WattTap

This article presents a simple connected Wattmeter based on a TapNLink module. The only 'processor' is the Java Virtual Machine embedded into the TapNLink module that runs a simple Java program. 

>> Note: if you wish to understand how works TapNLink and the associated tools (IoTize Studio), see [Getting Started](http://docs.iotize.com/GettingStarted/).

To find the project on GitHub, [it's here](https://github.com/iotize-sas/wattMeter-demo) !

It's composed of 4 folder:

- `app_generated/WattTap.apk`: Source for the mobile application. It was auto generated by IoTize mobile app build server.
- `java/WattTap.java`: Contains a Java code which will be executed by the `JVM`.
- `iotize_studio/WattTap.iotz`: IoTize Studio configuration file to configure the TapNLink for the demo.
- `doc/WattTapDemo.pdf`: Contains documentation that explains the use of Studio as well as the description of the `Java` code.

## VERY IMPORTANT WARNING

**This Wattmeter is supposed to be directly connected to the mains. Vss will be at 220V voltage and a physical contact with any component of the board could cause very serious injury.  
In conclusion, do not try to reproduce this equipment if you don't understand perfectly what you are doing and/or if you don't have any protection equipment (such as an isolation transformer,...).**


## The main components

If you wish to purchase the main components follow these links:
- TapNLink (the communication module), [it's here](https://www.digikey.fr/product-detail/fr/iotize/TNL-FIT203/2087-TNL-FIT203-ND/12397002).
- BL0937 (the power sensor), [it's here](https://www.aliexpress.com/wholesale?catId=0&initiative_id=SB_20210218083908&isPremium=y&SearchText=bl0937).
- the plastic enclosure, [it's here](https://www.aliexpress.com/item/4000287507400.html?spm=a2g0o.productlist.0.0.309d44dfcbyy66&algo_pvid=642dec70-5635-4468-b159-30d6b13c2028&algo_expid=642dec70-5635-4468-b159-30d6b13c2028-3&btsid=2100bb5116136655014285201e8088&ws_ab_test=searchweb0_0,searchweb201602_,searchweb201603_).


## How it works

Below a few pictures. An extension cord has been cut and each half has been connected to the board: 

<p align="center">
<img src="/doc/images/picture_1.jpg" width="250">
</p>
<p align="center">
    <em>Assembly of the wattmeter</em>
</p>
<p>
The wattmeter acts as a spy between the mains plug and the load.
</p>
<p align="center">
<img src="/doc/images/picture_2.jpg" width="250">
</p>
<p align="center">
    <em>Inside the enclosure</em>
</p>
<p>
In the plastic case, the TapNLink module is linked with a small ribbon cable. 
</p>

<p align="center">
<img src="/doc/images/picture_3.jpg" width="250">
</p>
<p align="center">
    <em>TapNLink isolation</em>
</p>
<p>
An isolation (Kapton tape) has been added between the tap and the main board to avoid a short. 
</p>

## Overview

<p align="center">
<img src="/doc/images/diagram.png">
</p>
<p align="center">
    <em>General view of the project</em>
</p>
<p>
The general diagram shows the mains plug connected to the wattmeter.
The wattmeter is based on a single component (BL0937) that measures both the current and the voltage and calculates the instant power consumption. The TapNLink module reads the information from this sensor and transmits the data to a smartphone thanks to the generated application (the IoTize environment allows to generate automatically mobiles apps from the configuration of the module).
</p>

## Schematic 

<p align="center">
<img src="/doc/images/wattmeter.png">
</p>
<p align="center">
    <em>Electric diagram</em>
</p>
<p>
The current is measured through R1 (1 mOhm resistor).
The voltage is divided through a serie of 330ko resistors before reaching the sensor. Several resistors have been preferred because of the high voltage. 
</p>

#### BL0937 to TapNLink
The TapNLink has a two extension connectors, but the main 'target connector' is used a s a set of simple GPIOs. 
Because the data is sent as a serie of pulses (the power is proportional to the frequency of the output signals), the input will be configured as counters. 
The BL0937 has two output: 
- `CF0` (power), connected to `TARGET_RST` of the Tap,
- `CF1` (current/voltage), connected to the `TARGET_SWDIO`pin,
The selection of current vs voltage is done by `SEL` connected to the `TARGET_SWDIO`pin.

<p align="center">
<img src="/doc/images/tap_targ.png" width="300">
</p>
<p align="center">
    <em>Target paw of the TapNLink</em>
</p>

## Java code

In the `Java` code executed by the `JVM`, the `onCheck()` method is called periodically (the period is specified in the `TapNLinkVar` constructor). In this method, we get an image of the power by considering the differences of the pulses counts during the elapsed time. 

- To find more `Java` code information, [it's here](https://github.com/iotize-sas/wattMeter-demo/blob/master/doc/Java_code/Java_code.md) !


## IoTize Studio

1. Open `iotize_studio/WattTap.iotz` with IoTize Studio. For more information about Studio, see [it's here](http://docs.iotize.com/UserManuals/IotizeStudio/).
2. On `IoTize_Studio/Tap`, define `User internal JVM` on `Yes` and select the `.java` file path `java/WattTap.java`.
3. On Studio execute `java` build for generate `.bcb` file. 
4. Configure your `TapNLink` with `IoTize Studio` :
    -  [Setup connection to your Tap](http://docs.iotize.com/UserManuals/DiverseTools/)
    -  [Setup IoT Platform (MQTT) information](http://docs.iotize.com/Technologies/AWSIot/).
    -  Click on `Configure` button and wait for the end of the configuration process. 
5. Reboot the tap to apply the new configuration. 


## Running the 'WattTap' app

- Because the App has not been published onto the stores, you have to install it manually, see [it's here](https://github.com/iotize-sas/wattMeter-demo/blob/master/app_generated/WattTap.apk).
- Once your circuit is properly connected, and your TapNLink configured, you can launch the mobile app. The fastest way consists in approching your mobile phone (with NFC enabled) to the plastic enclosure. The NFC will launch the app and connect automatically to the TapNLink. 

<p align="center">
<img src="/doc/images/picture_end.jpg" width="400">
</p>
<p align="center">
   <em>Wattmeter connected to a device</em>
</p>

- Thanks to the `TapNLink`you can now monitor the instant power consumption, or get the passed consumption that have been stored into the module. 

<p align="center">
<img src="/doc/images/app.jpg" width="200">
</p>
<p align="center">
    <em>Viewing the application</em>
</p>

## Calibration

Because we didn't use very precise components, we have to calibrate our Wattmeter before considering the values as correct. We will use a  multimeter (thus the overall precision will depend on the multimeter precision).
Note that we focus onto the active power and we need a pure resistor and use an electric radiator (do not use your washing machine that could have a high inductance). 

1. On WattTap application go `Login` on a left bar.
2. Enter your admin account to access more parameters.
3. Once connected, the Bundle `Calibration` is displayed. Click on this one.
4. Now you should define the active power, current and voltage factor to 1.
<p align="center">
<img src="/doc/images/app_calibration.jpg" width="200">
</p>
<p align="center">
    <em>Calibration value</em>
</p>
5. Now the pulse from active power, current and voltage doesn't get calibration and return pin value.


>>
> For each calibration you have an action to perform.

#### Voltage :

- On VoltMeter we find 230V, on WattTap the `Pin` value on voltage has 1765.
- Then you should create the calibration with this form :
    * 230 / 1765 = 0.1303116147308782.
    * Now change the voltage calibration to 0.13031.
    * `Java` code do 1765 * calibration to find 230V.

#### Electric Current

- On VoltMeter we find 4A, on WattTap the `Pin` value on current has 561.
- Then you should create the calibration with this form :
    * 4 / 561 = 0,0071301247771836.
    * Now change the current calibration to 0.00713.
    * `Java` code do 561 * calibration to find 4A.

#### Active Power:

- On VoltMeter we find 230V and 4A, on WattTap the `Pin` value on target has 985
- Then you should create calibration with this form :
    * 230 * 4 = 920.
    * Now we know the power active should be equals to 920.
    * 920 / 985 = 0.934010152284264.
    * Now change the active power calibration to 0.93401.
    * `Java` code do 985 * calibration to find 920W.

## Send MQTT message to AWS to generate shadow on thing

<p>
You should be login with admin account like calibration change to define update shadow on AWS `active`.
</p>
<p align="center">
<img src="/doc/images/picture_aws.jpg" width="200">
</p>
<p align="center">
    <em>Turn on MQTT message to AWS</em>
</p>

>> You must put right `AWS` info on `IoT Platform (MQTT)`, else the `JVM` will be stop a few seconds when tap try to send this.


- If successfull :
<p align="center">
<img src="/doc/images/mqtt_shadow.png" width="800">
</p>
<p align="center">
    <em>AWS find MQTT message</em>
</p>

## More information

- To find more information on the creation of this project, [it's here](https://github.com/iotize-sas/wattMeter-demo/blob/master/doc/WattTapDemo.pdf).


## WattTap v2

To change the generated code, you must go to the build accessible on the iotize cloud

>> Note: if you want to install this version, you must unistall the other wattTap version on your mobile than install this one.

After a few hours of changes to the generated code, I was able to make the following changes:  

<p align="center">
<img src="/doc/images/v2_1.jpg" width="250">
</p>
<p align="center">
    <em>New Chart bar</em>
</p>
The hours/days/months consumption has showed on chart bar now.

<p align="center">
<img src="/doc/images/v2_gauge.jpg" width="250">
</p>
<p align="center">
    <em>New gauge display</em>
</p>
The current and voltage got different gauge now